<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê·€ì—¼ë½€ì§ ê°•ì•„ì§€ í‚¤ìš°ê¸°</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Gowun Dodum', sans-serif;
      background-color: #fff8f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 30px;
      font-size: 3rem;
      color: #ff914d;
    }
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .active {
      display: flex !important;
    }
    .button {
      padding: 14px 28px;
      margin: 10px;
      font-size: 1.1rem;
      background: #ffd1dc;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background 0.2s;
    }
    .button:hover {
      background: #ffa4a4;
    }
    input {
      padding: 12px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-top: 10px;
      width: 220px;
    }
    #game-wrapper {
      width: 90vw;
      max-width: 1000px;
      height: 680px;
      position: relative;
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .status-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 0.95rem;
      line-height: 1.4;
      border: 1px solid #ffdad5;
    }
    .event-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 243, 234, 0.95);
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 0.95rem;
      color: #cc5c00;
      border: 1px dashed #ffa65e;
    }
    .celebrate {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.2rem;
      background: #fff3cd;
      color: #d9480f;
      padding: 15px 25px;
      border: 2px solid #ffd6a5;
      border-radius: 20px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
      z-index: 999;
      display: none;
    }
    .interaction-toggle {
      margin-top: 20px;
    }
    .interaction-panel {
      display: none;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
    .interaction-panel .button {
      background: #d2f4dc;
      margin: 5px;
    }
    #event-box {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 25px;
      border-radius: 20px;
      border: 2px solid #ffcdcd;
      box-shadow: 0 5px 10px rgba(0,0,0,0.05);
      text-align: center;
      display: none;
      z-index: 10;
    }
    #event-choices {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    #event-choices .button {
      font-size: 0.9rem;
      padding: 8px 16px;
    }
    #start-button-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 100px;
    }
  </style>
</head>
<body>
  <h1>ğŸ¾ ê·€ì—¼ë½€ì§ ê°•ì•„ì§€ í‚¤ìš°ê¸°</h1>

  <!-- ì²« ì‹œì‘í™”ë©´ -->
  <div id="start-button-screen" class="screen active">
    <button class="button" onclick="goToBreedScreen()">ê²Œì„ ì‹œì‘</button>
  </div>

  <!-- í’ˆì¢… ì„ íƒ -->
  <div id="breed-screen" class="screen">
    <p>ê°•ì•„ì§€ í’ˆì¢…ì„ ì„ íƒí•˜ì„¸ìš”:</p>
    <div>
      <button class="button" onclick="selectBreed('g')">ê³¨ë“  ë¦¬íŠ¸ë¦¬ë²„</button>
      <button class="button" onclick="selectBreed('b')">ë¹„ìˆ‘ í”„ë¦¬ì œ</button>
    </div>
  </div>

  <!-- ì´ë¦„ ì…ë ¥ -->
  <div id="name-screen" class="screen">
    <p>ê°•ì•„ì§€ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”:</p>
    <input type="text" id="puppy-name" placeholder="ì˜ˆ: ë­‰ì¹˜" />
    <button class="button" onclick="startGame()">ì‹œì‘!</button>
  </div>

  <!-- ë³¸ ê²Œì„ í™”ë©´ -->
  <div id="game-screen" class="screen">
    <div id="game-wrapper">
      <canvas id="gameCanvas" width="800" height="480"></canvas>
      <div class="status-bar" id="statusBar"></div>
      <div class="event-timer" id="eventTimer">ë‹¤ìŒ ì´ë²¤íŠ¸ê¹Œì§€: 20ì´ˆ</div>
      <div class="celebrate" id="celebrate">ğŸ‰ ì„±ì¥í–ˆì–´ìš”!</div>
      <div id="event-box">
        <div id="event-text">ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸</div>
        <div id="event-choices"></div>
      </div>
    </div>

    <div class="interaction-toggle">
      <button class="button" onclick="toggleInteractionPanel()">ì§ì ‘ ìƒí˜¸ì‘ìš© ğŸ”</button>
    </div>
    <div class="interaction-panel" id="interactionPanel">
      <button class="button" onclick="directInteraction('ì“°ë‹¤ë“¬ê¸°')">ì“°ë‹¤ë“¬ê¸°</button>
      <button class="button" onclick="directInteraction('ê·€ ëƒ„ìƒˆ ë§¡ê¸°')">ê·€ ëƒ„ìƒˆ ë§¡ê¸°</button>
      <button class="button" onclick="directInteraction('ë°œ ëƒ„ìƒˆ ë§¡ê¸°')">ë°œ ëƒ„ìƒˆ ë§¡ê¸°</button>
      <button class="button" onclick="directInteraction('ê»´ì•ˆê¸°')">ê»´ì•ˆê¸°</button>
    </div>

    <audio id="bgm" loop autoplay>
      <source src="https://dessa95.github.io/puppy-game-drive/bgm.mp3" type="audio/mp3" />
    </audio>
  </div>
  <script>
    let puppyName = "";
    let puppyBreed = "";
    let puppyAge = 0;
    let puppyMood = "í‰ì˜¨";
    let ageTimer, eventTimer, agingPaused = false;
    let currentStage = "ì‹ ìƒì•„ê¸°";
    let lastImage = "";
    let isEventRunning = false;
    let growthCelebrationPending = false;
    let memoryImages = [];

    function showScreen(screenId) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(screenId).classList.add("active");
    }

    function goToBreedScreen() {
      showScreen("breed-screen");
    }

    function selectBreed(breed) {
      puppyBreed = breed;
      showScreen("name-screen");
    }

    function startGame() {
      const nameInput = document.getElementById("puppy-name").value.trim();
      if (nameInput === "") {
        alert("ê°•ì•„ì§€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }
      puppyName = nameInput;
      showScreen("game-screen");
      initGame();
    }

    function initGame() {
      puppyAge = 0;
      updateStatusBar();
      updateCanvas();
      startTimers();
    }

    function startTimers() {
      ageTimer = setInterval(() => {
        if (!agingPaused) {
          puppyAge++;
          checkGrowth();
          updateStatusBar();
        }
      }, 20000); // 20ì´ˆë§ˆë‹¤ 1ì‚´

      eventTimer = setInterval(() => {
        if (!isEventRunning && !growthCelebrationPending) {
          triggerRandomEvent();
        }
      }, 5000); // 5ì´ˆë§ˆë‹¤ ì´ë²¤íŠ¸
    }

    function updateStatusBar() {
      let stage = getGrowthStage();
      if (stage !== currentStage) {
        currentStage = stage;
        growthCelebrationPending = true;
        showGrowthEffect();
        return;
      }

      document.getElementById("statusBar").innerHTML = `
        ğŸ¾ ì´ë¦„: ${puppyName}<br/>
        ğŸ“… ë‚˜ì´: ${puppyAge}ì„¸ (${currentStage})<br/>
        ğŸ˜Š ê¸°ë¶„: ${puppyMood}
      `;
    }

    function getGrowthStage() {
      if (puppyAge < 2) return "ì‹ ìƒì•„ê¸°";
      else if (puppyAge < 6) return "ì²­ì†Œë…„ê¸°";
      else if (puppyAge < 10) return "ì„±ë…„ê¸°";
      else return "ë…¸ë ¹ê¸°";
    }

    function showGrowthEffect() {
      const celeb = document.getElementById("celebrate");
      celeb.style.display = "block";
      celeb.innerHTML = `ğŸ‰ ${puppyName}ê°€ ${currentStage}ë¡œ ì„±ì¥í–ˆì–´ìš”!<br><button class="button" onclick="confirmGrowth()">ì¶•í•˜í•´ ğŸ‚</button>`;
      animateGrowth();
      agingPaused = true;
    }

    function confirmGrowth() {
      const celeb = document.getElementById("celebrate");
      celeb.style.display = "none";
      agingPaused = false;
      growthCelebrationPending = false;
    }
    function triggerRandomEvent() {
      isEventRunning = true;
      const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
      showEvent(event.text, event.choices, event.anim);
    }

    function showEvent(text, choices, animFunc) {
      agingPaused = true;
      const overlay = document.createElement("div");
      overlay.className = "event-overlay";
      overlay.style.position = "absolute";
      overlay.style.bottom = "10px";
      overlay.style.left = "50%";
      overlay.style.transform = "translateX(-50%)";
      overlay.style.background = "#fff";
      overlay.style.border = "2px solid #ffa65e";
      overlay.style.padding = "20px";
      overlay.style.borderRadius = "15px";
      overlay.style.boxShadow = "0 5px 15px rgba(0,0,0,0.2)";
      overlay.style.zIndex = "999";

      const textNode = document.createElement("div");
      textNode.innerHTML = `<p style="font-size: 1.1rem; margin-bottom: 10px;">${text}</p>`;
      overlay.appendChild(textNode);

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "button";
        btn.textContent = choice.text;
        btn.onclick = () => {
          if (choice.stat === "intimacy") puppyMood = "ì¢‹ìŒ";
          if (choice.stat2 && choice.stat2 === "intimacy") puppyMood = "ë§¤ìš° ì¢‹ìŒ";
          overlay.remove();
          isEventRunning = false;
          agingPaused = false;
          animFunc?.();
          updateStatusBar();
        };
        overlay.appendChild(btn);
      });

      document.getElementById("game-wrapper").appendChild(overlay);
    }

    function directInteraction(action) {
      const animFunc = {
        "ì“°ë‹¤ë“¬ê¸°": drawPetAnim,
        "ê·€ ëƒ„ìƒˆ ë§¡ê¸°": drawEarSniffAnim,
        "ë°œ ëƒ„ìƒˆ ë§¡ê¸°": drawPawSniffAnim,
        "ê»´ì•ˆê¸°": drawHugAnim,
      }[action];
      puppyMood = "í–‰ë³µ";
      animFunc?.();
      updateStatusBar();
    }

    function drawCanvasImage(src, effect = "") {
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        if (effect === "shake") shakeCanvas(canvas);
        if (effect === "pulse") pulseCanvas(canvas);
        memoryImages.push(src);
      };
      img.src = src;
      lastImage = src;
    }

    function drawWalkAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/walk.png", "shake"); }
    function drawBathAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/bath.png", "pulse"); }
    function drawEatAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/eat.png", "pulse"); }
    function drawPlayAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/play.png", "shake"); }
    function drawVetAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/vet.png", "pulse"); }
    function drawTrickAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/trick.png", "shake"); }
    function drawMessAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/mess.png", "pulse"); }
    function drawFriendAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/friend.png", "shake"); }
    function drawTreatAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/treat.png", "pulse"); }

    function drawPetAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/pet.png", "pulse"); }
    function drawEarSniffAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/ear.png", "shake"); }
    function drawPawSniffAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/paw.png", "shake"); }
    function drawHugAnim() { drawCanvasImage("https://dessa95.github.io/puppy-game-drive/hug.png", "pulse"); }

    function shakeCanvas(canvas) {
      canvas.classList.add("shake");
      setTimeout(() => canvas.classList.remove("shake"), 800);
    }

    function pulseCanvas(canvas) {
      canvas.classList.add("pulse");
      setTimeout(() => canvas.classList.remove("pulse"), 800);
    }
    function showCelebrate() {
      const msg = document.getElementById("celebrate");
      msg.style.display = "block";
      setTimeout(() => {
        msg.innerHTML = `<button class="button" onclick="continueAfterCelebrate()">ğŸ‰ ì¶•í•˜í•´</button>`;
      }, 1500);
    }

    function continueAfterCelebrate() {
      document.getElementById("celebrate").style.display = "none";
      isEventRunning = false;
      agingPaused = false;
    }

    function triggerGameOver() {
      const wrapper = document.getElementById("game-wrapper");
      const overlay = document.createElement("div");
      overlay.style.position = "absolute";
      overlay.style.top = "0";
      overlay.style.left = "0";
      overlay.style.width = "100%";
      overlay.style.height = "100%";
      overlay.style.background = "rgba(255,255,255,0.9)";
      overlay.style.zIndex = "999";
      overlay.style.display = "flex";
      overlay.style.flexDirection = "column";
      overlay.style.justifyContent = "center";
      overlay.style.alignItems = "center";

      const name = document.getElementById("puppy-name").value || "ìš°ë¦¬ ê°•ì•„ì§€";

      const text = document.createElement("p");
      text.textContent = `${name}ì´ê°€ ì˜ˆì˜ê³  ë©‹ì§€ê²Œ ìëì–´ìš”!`;
      text.style.fontSize = "1.5rem";
      text.style.marginBottom = "20px";

      const album = document.createElement("div");
      album.style.display = "flex";
      album.style.flexWrap = "wrap";
      album.style.justifyContent = "center";
      album.style.gap = "10px";
      album.style.maxWidth = "90%";
      album.style.maxHeight = "300px";
      album.style.overflow = "auto";

      memoryImages.forEach(src => {
        const img = new Image();
        img.src = src;
        img.style.width = "100px";
        img.style.height = "auto";
        img.style.borderRadius = "10px";
        album.appendChild(img);
      });

      const restartBtn = document.createElement("button");
      restartBtn.textContent = "ë‹¤ì‹œ ì‹œì‘í•˜ê¸°";
      restartBtn.className = "button";
      restartBtn.onclick = () => location.reload();

      overlay.appendChild(text);
      overlay.appendChild(album);
      overlay.appendChild(restartBtn);
      wrapper.appendChild(overlay);
    }
  </script>

  <style>
    @keyframes shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-5px, 5px); }
      50% { transform: translate(5px, -5px); }
      75% { transform: translate(-5px, 5px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .shake { animation: shake 0.8s; }
    .pulse { animation: pulse 0.8s; }
  </style>
</body>
</html>
