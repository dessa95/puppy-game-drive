<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강아지 키우기</title>
    <style>
        /* Pretendard 웹폰트 추가 */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body {
            background-color: #fdf6e3; /* 부드러운 크림색 배경 */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            color: #5d4037; /* 갈색 텍스트 */
            text-align: center;
            flex-direction: column;
            overflow: hidden;
        }

        #game-wrapper {
            position: relative;
            width: 95%;
            max-width: 800px;
            aspect-ratio: 4 / 3; /* 800x600 비율 유지 */
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-radius: 20px;
            background: #fff;
            border: 10px solid #fff;
        }

        canvas {
            background-color: #a7e0e0; /* 밝은 하늘색 배경 */
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            height: 100%;
            display: block;
        }

        .hidden { display: none; }

        h1 {
            color: #d4a373; /* 따뜻한 갈색 제목 */
            margin-bottom: 15px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* 로딩 화면 스타일 */
        #loading-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            color: #5d4037;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 10;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <h1>나만의 댕댕이를 키워보세요! 🐾</h1>
    <div id="game-wrapper">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="loading-screen">로딩 중...</div>
    </div>

    <audio id="bgm" loop class="hidden"></audio>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const bgm = document.getElementById('bgm');
    const loadingScreen = document.getElementById('loading-screen');

    // --- 게임 상태 및 설정 ---
    const BASE_URL = "https://dessa95.github.io/puppy-game-drive/";
    let gameState = 'LOADING'; // LOADING, START_SCREEN, CHOOSE_BREED, NAMING, PLAYING
    let dog = null;
    let gameTime = 0;
    let animationFrame = 0;
    let currentEvent = null;
    let dogNameInput = '';
    let lastLifecycleEventAge = -1;
    let musicStarted = false;
    let mousePos = { x: 0, y: 0 };
    let images = {}; // 이미지 객체 저장

    // --- 이미지 및 오디오 파일 경로 ---
    const ASSETS = {
        bgm: 'bgm.mp3',
        bichon_newborn: 'b1.png',
        bichon_teen: 'b2.png',
        bichon_adult: 'b3.png',
        bichon_senior: 'b4.png',
        retriever_newborn: 'g1.png',
        retriever_teen: 'g2.png',
        retriever_adult: 'g3.png',
        retriever_senior: 'g4.png',
    };

    // --- 품종 데이터 ---
    const breeds = {
        '비숑 프리제': {
            images: {
                '신생아기': 'bichon_newborn',
                '청소년기': 'bichon_teen',
                '성년기': 'bichon_adult',
                '노령기': 'bichon_senior'
            }
        },
        '골든 리트리버': {
            images: {
                '신생아기': 'retriever_newborn',
                '청소년기': 'retriever_teen',
                '성년기': 'retriever_adult',
                '노령기': 'retriever_senior'
            }
        }
    };

    // --- 생애 주기 및 이벤트 데이터 ---
    const lifecycle = [
        { age: 0, stage: "신생아기", event: "세상에 태어났어요! 안녕?" },
        { age: 2, stage: "청소년기", event: "에너지가 넘쳐요! '개린이'가 되었어요." },
        { age: 6, stage: "성년기", event: "늠름한 성견이 되었어요." },
        { age: 10, stage: "노령기", event: "이제는 잠이 많아졌어요. 곁에 있어주세요." }
    ];
    
    // 이벤트에 애니메이션 함수 추가
    const randomEvents = [
        { text: "산책 갈 시간이에요!", choices: [{ text: "신나게 달린다", stat: 'intimacy', value: 10 }, { text: "천천히 걷는다", stat: 'intimacy', value: 5 }], anim: drawWalkAnim },
        { text: "목욕할 시간! 물이 싫어요!", choices: [{ text: "부드럽게 씻긴다", stat: 'intimacy', value: 5 }, { text: "간식을 주며 달랜다", stat: 'hunger', value: 10, stat2: 'intimacy', value2: 2 }], anim: drawBathAnim },
        { text: "배가 고파요! 밥 주세요!", choices: [{ text: "사료를 준다", stat: 'hunger', value: 20 }, { text: "특식을 준다", stat: 'hunger', value: 30, stat2: 'intimacy', value2: 5 }], anim: drawEatAnim },
        { text: "놀아주세요!", choices: [{ text: "공놀이를 한다", stat: 'intimacy', value: 15 }, { text: "터그 놀이를 한다", stat: 'intimacy', value: 12 }], anim: drawPlayAnim }
    ];

    // --- 에셋 로딩 ---
    function loadAssets() {
        const promises = [];
        for (const key in ASSETS) {
            if (key === 'bgm') {
                bgm.src = BASE_URL + ASSETS[key];
            } else {
                const img = new Image();
                img.src = BASE_URL + ASSETS[key];
                images[key] = img;
                // [FIX] Add onerror handler to prevent getting stuck
                promises.push(new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = () => {
                        console.error(`Failed to load image: ${img.src}`);
                        resolve(); // Resolve even if image fails to load
                    };
                }));
            }
        }
        return Promise.all(promises);
    }

    // --- 그리기 함수 ---
    function drawBackground() {
        // 바닥
        ctx.fillStyle = '#f4a261';
        ctx.fillRect(0, 450, canvas.width, 150);
        // 벽
        ctx.fillStyle = '#e9c46a';
        ctx.fillRect(0, 0, canvas.width, 450);
        // 창문
        ctx.fillStyle = '#a2d2ff';
        ctx.fillRect(550, 100, 150, 100);
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 5;
        ctx.strokeRect(550, 100, 150, 100);
        ctx.beginPath();
        ctx.moveTo(625, 100); ctx.lineTo(625, 200);
        ctx.moveTo(550, 150); ctx.lineTo(700, 150);
        ctx.stroke();
    }

    function drawDog() {
        if (!dog) return;
        const stageInfo = lifecycle.find(s => dog.age >= s.age && (!lifecycle[lifecycle.indexOf(s) + 1] || dog.age < lifecycle[lifecycle.indexOf(s) + 1].age));
        const imageName = breeds[dog.breed].images[stageInfo.stage];
        const img = images[imageName];
        if (!img || !img.complete || img.naturalHeight === 0) return; // 이미지가 로드되었는지 확인

        const bobbing = Math.sin(animationFrame * 0.05) * 5;
        const scale = 0.6 + (dog.age / 15) * 0.2; // 나이에 따라 크기 조절
        const imgWidth = img.width * scale;
        const imgHeight = img.height * scale;
        const dogX = canvas.width / 2 - imgWidth / 2;
        const dogY = canvas.height - imgHeight - 50 + bobbing;
        
        // 그림자
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.beginPath();
        ctx.ellipse(canvas.width / 2, canvas.height - 40, imgWidth / 2, 10);
        ctx.fill();

        ctx.drawImage(img, dogX, dogY, imgWidth, imgHeight);
    }

    // --- UI 그리기 ---
    function drawUI() {
        if (gameState !== 'PLAYING') return;
        
        ctx.save();
        // UI 패널
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.strokeStyle = '#d4a373';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.roundRect(10, 10, 320, 120, 15);
        ctx.fill();
        ctx.stroke();
        
        // 텍스트
        ctx.fillStyle = '#5d4037';
        ctx.font = 'bold 22px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`🐾 ${dog.name}`, 25, 45);
        ctx.font = '18px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.fillText(`🎂 ${dog.age}살 (${dog.stage})`, 25, 75);

        // 게이지
        const drawGauge = (label, value, color, y) => {
            ctx.fillText(label, 25, y + 12);
            ctx.fillStyle = '#e0e0e0';
            ctx.beginPath();
            ctx.roundRect(110, y, 190, 18, 9);
            ctx.fill();
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(110, y, Math.max(0, value) * 1.9, 18, 9);
            ctx.fill();
            ctx.fillStyle = '#5d4037';
        };
        drawGauge('친밀도', dog.stats.intimacy, '#ff8fab', 95);
        drawGauge('배고픔', dog.stats.hunger, '#fca311', 120);
        ctx.restore();
    }

    // --- 이벤트 애니메이션 ---
    function drawWalkAnim() {
        const sunX = 700, sunY = 80;
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(sunX, sunY, 40, 0, Math.PI * 2);
        ctx.fill();
        // 햇살
        for(let i=0; i<8; i++){
            const angle = (i * Math.PI / 4) + (animationFrame * 0.02);
            ctx.beginPath();
            ctx.moveTo(sunX, sunY);
            ctx.lineTo(sunX + Math.cos(angle) * 60, sunY + Math.sin(angle) * 60);
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
            ctx.lineWidth = 3;
            ctx.stroke();
        }
    }
    function drawBathAnim() {
        for(let i=0; i<5; i++){
            const x = canvas.width / 2 + Math.sin(animationFrame * 0.05 + i) * (100 + i*20);
            const y = canvas.height / 2 - 50 - Math.cos(animationFrame * 0.05 + i) * 20;
            const r = 10 + Math.sin(animationFrame * 0.1 + i*2) * 5;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    }
    function drawEatAnim() {
        const heartX = canvas.width / 2;
        const heartY = 150 + Math.sin(animationFrame * 0.1) * 10;
        ctx.font = '50px sans-serif';
        ctx.fillStyle = '#ff4d6d';
        ctx.fillText('❤️', heartX, heartY);
    }
    function drawPlayAnim() {
        const ballX = 100 + (animationFrame % 200) * 3;
        const ballY = 300 + Math.sin((animationFrame % 200) * Math.PI / 100) * 100;
        ctx.fillStyle = '#d90429';
        ctx.beginPath();
        ctx.arc(ballX, ballY, 20, 0, Math.PI * 2);
        ctx.fill();
    }

    function drawButton(text, x, y, width, height, hover) {
        ctx.save();
        if (hover) {
            ctx.fillStyle = '#FFD700';
            ctx.shadowColor = 'rgba(255, 215, 0, 0.7)';
            ctx.shadowBlur = 15;
        } else {
            ctx.fillStyle = '#FFF';
        }
        ctx.strokeStyle = '#d4a373';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.roundRect(x, y, width, height, 15);
        ctx.fill();
        ctx.stroke();
        ctx.restore();
        
        ctx.fillStyle = '#5d4037';
        ctx.font = 'bold 22px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, x + width / 2, y + height / 2);
    }

    function drawEvent() {
        if (!currentEvent) return;
        ctx.fillStyle = `rgba(0, 0, 0, 0.7)`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (currentEvent.anim) currentEvent.anim();

        ctx.fillStyle = '#FFF';
        ctx.font = 'bold 32px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(currentEvent.text, canvas.width / 2, canvas.height / 2 - 80);

        currentEvent.choices.forEach((choice, index) => {
            const btnWidth = 320;
            const btnHeight = 55;
            const btnX = canvas.width / 2 - btnWidth / 2;
            const btnY = canvas.height / 2 + (index * (btnHeight + 15));
            choice.x = btnX;
            choice.y = btnY;
            choice.width = btnWidth;
            choice.height = btnHeight;
            const hover = isMouseOver(choice);
            drawButton(choice.text, btnX, btnY, btnWidth, btnHeight, hover);
        });
    }

    function drawScreen(title, subtitle) {
        ctx.fillStyle = '#2a9d8f';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#FFF';
        ctx.font = 'bold 48px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(title, canvas.width / 2, canvas.height / 2 - 40);
        ctx.font = '22px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.fillText(subtitle, canvas.width / 2, canvas.height / 2 + 20);
    }
    
    function drawBreedSelection() {
        drawScreen('어떤 강아지를 키울까요?', '');
        const breedNames = Object.keys(breeds);
        breedNames.forEach((breed, index) => {
            const btnY = 280 + index * 80;
            breeds[breed].btn = { x: canvas.width/2 - 150, y: btnY, width: 300, height: 60 };
            const hover = isMouseOver(breeds[breed].btn);
            drawButton(breed, breeds[breed].btn.x, breeds[breed].btn.y, breeds[breed].btn.width, breeds[breed].btn.height, hover);
        });
    }

    function drawNamingScreen() {
        drawScreen('강아지의 이름을 지어주세요', '키보드로 입력하고 Enter를 누르세요');
        ctx.fillStyle = '#FFF';
        ctx.strokeStyle = '#d4a373';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.roundRect(canvas.width / 2 - 200, canvas.height / 2 + 60, 400, 60, 10);
        ctx.fill();
        ctx.stroke();
        
        ctx.fillStyle = '#5d4037';
        ctx.font = '32px "Pretendard", "Malgun Gothic", sans-serif';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        const cursor = (Math.floor(animationFrame / 30) % 2 === 0) ? '|' : '';
        ctx.fillText(dogNameInput + cursor, canvas.width / 2 - 190, canvas.height / 2 + 90);
    }

    // --- 게임 로직 ---
    function update() {
        animationFrame++;
        if (gameState !== 'PLAYING' || currentEvent) return;

        gameTime++;
        
        // 1분에 한 살씩 나이 먹기 (60프레임 * 60초)
        if (gameTime % 3600 === 0) {
            dog.age++;
            checkLifecycle();
        }
        
        // 1초마다 상태 변화
        if (gameTime % 60 === 0) {
            dog.stats.hunger = Math.max(0, dog.stats.hunger - 0.5);
            dog.stats.intimacy = Math.max(0, dog.stats.intimacy - 0.2);
        }

        // 10초마다 랜덤 이벤트 발생 (60프레임 * 10초)
        if (gameTime > 300 && gameTime % 600 === 0) {
            triggerRandomEvent();
        }
    }
    
    function checkLifecycle() {
        const currentStage = lifecycle.find(s => dog.age === s.age);
        if (currentStage && dog.age > lastLifecycleEventAge) {
            lastLifecycleEventAge = dog.age;
            dog.stage = currentStage.stage;
            currentEvent = {
                text: currentStage.event,
                choices: [{ text: "알았어!" }],
                isLifecycle: true
            };
        }
    }

    function triggerRandomEvent() {
        if (currentEvent) return;
        const eventIndex = Math.floor(Math.random() * randomEvents.length);
        currentEvent = JSON.parse(JSON.stringify(randomEvents[eventIndex]));
        currentEvent.anim = randomEvents[eventIndex].anim;
    }

    function selectEventChoice(choice) {
        if (choice.stat) {
            dog.stats[choice.stat] = Math.min(100, dog.stats[choice.stat] + choice.value);
        }
        if (choice.stat2) {
            dog.stats[choice.stat2] = Math.min(100, dog.stats[choice.stat2] + choice.value2);
        }
        currentEvent = null;
    }

    function isMouseOver(rect) {
        if (!rect) return false;
        return mousePos.x > rect.x && mousePos.x < rect.x + rect.width &&
               mousePos.y > rect.y && mousePos.y < rect.y + rect.height;
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        update();

        if (gameState === 'PLAYING') {
            drawBackground();
            drawDog();
            drawUI();
            if (currentEvent) {
                drawEvent();
            }
        } else if (gameState === 'START_SCREEN') {
            drawScreen('강아지 키우기', '클릭해서 시작하기');
        } else if (gameState === 'CHOOSE_BREED') {
            drawBreedSelection();
        } else if (gameState === 'NAMING') {
            drawNamingScreen();
        }
        
        requestAnimationFrame(gameLoop);
    }

    // --- 이벤트 핸들러 ---
    function handleCanvasClick(e) {
        if (!musicStarted) {
            bgm.volume = 0.3;
            bgm.play().catch(err => console.log("BGM 재생 실패:", err));
            musicStarted = true;
        }

        if (gameState === 'START_SCREEN') {
            gameState = 'CHOOSE_BREED';
        } else if (gameState === 'CHOOSE_BREED') {
            const breedNames = Object.keys(breeds);
            for (const breed of breedNames) {
                if (isMouseOver(breeds[breed].btn)) {
                    dog = {
                        breed: breed, name: '', age: 0, stage: '신생아기',
                        stats: { intimacy: 50, hunger: 50 }
                    };
                    gameState = 'NAMING';
                    break;
                }
            }
        } else if (gameState === 'PLAYING' && currentEvent) {
            currentEvent.choices.forEach(choice => {
                if (isMouseOver(choice)) {
                    selectEventChoice(choice);
                }
            });
        }
    }

    function handleMouseMove(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        mousePos.x = (e.clientX - rect.left) * scaleX;
        mousePos.y = (e.clientY - rect.top) * scaleY;
    }

    function handleKeyDown(e) {
        if (gameState !== 'NAMING') return;

        if (e.key === 'Enter' && dogNameInput.length > 0) {
            dog.name = dogNameInput;
            gameState = 'PLAYING';
            checkLifecycle();
        } else if (e.key === 'Backspace') {
            dogNameInput = dogNameInput.slice(0, -1);
        } else if (e.key.length === 1 && dogNameInput.length < 10) {
            // [FIX] Correct regex to allow Korean, English, numbers, and spaces
            if (/^[ㄱ-ㅎ가-힣a-zA-Z0-9\s]$/.test(e.key)) {
                dogNameInput += e.key;
            }
        }
    }

    // --- 초기화 ---
    async function init() {
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('keydown', handleKeyDown);
        await loadAssets();
        loadingScreen.classList.add('hidden');
        gameState = 'START_SCREEN';
        gameLoop();
    }

    init();
</script>
</body>
</html>
